<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Garden AR - Mobile Friendly</title>
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <!-- AR.js for camera access -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        .arjs-loader {
            position: fixed;
            z-index: 999;
            overflow: show;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .arjs-loader div {
            text-align: center;
            color: white;
            max-width: 80%;
            font-family: Arial, Helvetica, sans-serif;
            padding: 20px;
        }
        
        /* Instructions */
        #instructions {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
            max-width: 80%;
        }
        
        /* Place button */
        #place-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        /* Reset button */
        #reset-button {
            position: fixed;
            bottom: 20px;
            right: 90px;
            width: 60px;
            height: 60px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        /* Response toggle */
        #response-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        /* Response form */
        #response-form {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            color: white;
            z-index: 100;
            display: none;
        }
        
        #response-form input,
        #response-form textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            font-family: Arial, sans-serif;
        }
        
        #response-form textarea {
            height: 80px;
            resize: none;
        }
        
        #response-form button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }
        
        #response-form h3 {
            margin-top: 0;
            text-align: center;
        }
        
        #response-status {
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            min-height: 20px;
        }
        
        /* Touch target overlay for tapping */
        #touch-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99;
            /* Important: we'll make this transparent but still catch touch events */
            background: rgba(0, 0, 0, 0.01);
        }
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div class="arjs-loader">
        <div>
            <h1>Community Garden AR</h1>
            <p>Loading... Please allow camera access when prompted.</p>
            <p>Tap anywhere to place the garden in your space!</p>
        </div>
    </div>
    
    <!-- Instructions -->
    <div id="instructions">Tap anywhere on your screen to place the garden</div>
    
    <!-- Buttons for garden controls -->
    <button id="place-button">üìç</button>
    <button id="reset-button">‚Ü∫</button>
    <button id="response-toggle">+</button>
    
    <!-- Touch overlay for tap detection -->
    <div id="touch-overlay"></div>
    
    <!-- Response form -->
    <div id="response-form">
        <h3>Share Your Thoughts</h3>
        <form id="garden-response-form">
            <label for="name">Your Name:</label>
            <input type="text" id="name" name="name" required>
            
            <label for="message">Why do you think this should be a community garden?</label>
            <textarea id="message" name="message" required></textarea>
            
            <button type="submit">Submit</button>
        </form>
        <div id="response-status"></div>
    </div>
    
    <!-- A-Frame scene -->
    <a-scene embedded vr-mode-ui="enabled: false">
        <!-- Camera settings -->
        <a-entity camera position="0 1.6 0" look-controls="enabled: false"></a-entity>
        
        <!-- Garden preview entity - shown when user taps -->
        <a-entity id="garden-preview" visible="false">
            <a-circle 
                material="color: #7c5c3c; opacity: 0.5; side: double" 
                rotation="-90 0 0" 
                radius="2" 
                position="0 0 0">
            </a-circle>
        </a-entity>
        
        <!-- Actual garden entity - hidden until placement is confirmed -->
        <a-entity id="garden-container" visible="false">
            <!-- Ground -->
            <a-circle
                material="color: #7c5c3c; opacity: 0.3; side: double"
                rotation="-90 0 0"
                radius="2"
                position="0 0 0">
            </a-circle>
            
            <!-- Text above garden -->
            <a-text
                id="garden-text"
                value="Why can't this be a community garden?"
                color="white"
                align="center"
                width="2"
                position="0 1 0"
                look-at="[camera]"
                animation="property: position; to: 0 1.1 0; dur: 3000; easing: easeInOutSine; loop: true; dir: alternate;">
            </a-text>
            
            <!-- Response display -->
            <a-text
                id="response-display"
                value=""
                color="#B3FFAE"
                align="center"
                width="1.5"
                position="0 0.6 0"
                look-at="[camera]"
                animation="property: position; to: 0 0.7 0; dur: 4000; easing: easeInOutSine; loop: true; dir: alternate; delay: 1500;">
            </a-text>
            
            <!-- Flower container -->
            <a-entity id="flower-container"></a-entity>
        </a-entity>
        
        <!-- Light -->
        <a-light type="ambient" color="#BBB" intensity="1"></a-light>
        <a-light type="directional" color="#FFF" intensity="0.6" position="-0.5 1 1"></a-light>
    </a-scene>
    
    <script>
        // Wait for scene to load
        document.addEventListener('DOMContentLoaded', function() {
            // Get references to DOM elements
            const arjsLoader = document.querySelector('.arjs-loader');
            const instructions = document.getElementById('instructions');
            const placeButton = document.getElementById('place-button');
            const resetButton = document.getElementById('reset-button');
            const responseToggle = document.getElementById('response-toggle');
            const responseForm = document.getElementById('response-form');
            const touchOverlay = document.getElementById('touch-overlay');
            const gardenPreview = document.getElementById('garden-preview');
            const gardenContainer = document.getElementById('garden-container');
            const cameraEl = document.querySelector('[camera]');
            
            // App state
            let isPlaced = false;
            let tapPosition = { x: 0, y: 0, z: -3 }; // Default position in front of camera
            
            // Hide loader after a short delay
            setTimeout(() => {
                arjsLoader.style.display = 'none';
                
                // Start camera feed
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        // Create video element for camera background
                        const video = document.createElement('video');
                        video.srcObject = stream;
                        video.style.position = 'fixed';
                        video.style.top = '0';
                        video.style.left = '0';
                        video.style.width = '100%';
                        video.style.height = '100%';
                        video.style.objectFit = 'cover';
                        video.style.zIndex = '-1';
                        video.play();
                        document.body.insertBefore(video, document.body.firstChild);
                    })
                    .catch(function(err) {
                        console.error('Error accessing camera:', err);
                        alert('Camera access is required for this AR experience.');
                    });
            }, 2000);
            
            // Handle touch/click for garden placement
            touchOverlay.addEventListener('click', function(event) {
                if (isPlaced) return;
                
                // Calculate tap position in 3D space
                // For simplicity, we'll place it at a fixed distance in front of the camera
                // in the direction the user tapped
                
                // Get viewport dimensions
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                // Calculate normalized device coordinates (-1 to 1)
                const ndcX = (event.clientX / width) * 2 - 1;
                const ndcY = -(event.clientY / height) * 2 + 1;
                
                // Fixed distance from camera
                const distance = 3;
                
                // Simple projection
                tapPosition = {
                    x: ndcX * distance,
                    y: 0, // Keep at ground level
                    z: -distance // Always in front of camera
                };
                
                // Update preview position
                gardenPreview.setAttribute('position', `${tapPosition.x} ${tapPosition.y} ${tapPosition.z}`);
                gardenPreview.setAttribute('visible', true);
                
                // Update instructions
                instructions.textContent = 'Tap the place button to confirm location';
                
                // Show place button more prominently
                placeButton.style.backgroundColor = '#4CAF50';
                placeButton.style.transform = 'scale(1.1)';
                placeButton.style.transition = 'transform 0.3s ease, background-color 0.3s ease';
            });
            
            // Handle place button click
            placeButton.addEventListener('click', function() {
                if (isPlaced) return;
                
                // Position garden at tap location
                gardenContainer.setAttribute('position', `${tapPosition.x} ${tapPosition.y} ${tapPosition.z}`);
                gardenContainer.setAttribute('visible', true);
                
                // Hide preview
                gardenPreview.setAttribute('visible', false);
                
                // Update UI
                placeButton.style.display = 'none';
                resetButton.style.display = 'flex';
                responseToggle.style.display = 'flex';
                instructions.style.display = 'none';
                touchOverlay.style.display = 'none'; // Disable touch overlay
                
                // Mark as placed
                isPlaced = true;
                
                // Place flowers
                placeFlowers();
            });
            
            // Handle reset button click
            resetButton.addEventListener('click', function() {
                if (!isPlaced) return;
                
                // Hide garden
                gardenContainer.setAttribute('visible', false);
                
                // Reset UI
                resetButton.style.display = 'none';
                placeButton.style.display = 'flex';
                responseToggle.style.display = 'none';
                responseForm.style.display = 'none';
                instructions.style.display = 'block';
                instructions.textContent = 'Tap anywhere on your screen to place the garden';
                touchOverlay.style.display = 'block'; // Re-enable touch overlay
                
                // Reset state
                isPlaced = false;
                
                // Clear flowers
                const flowerContainer = document.getElementById('flower-container');
                while (flowerContainer.firstChild) {
                    flowerContainer.removeChild(flowerContainer.firstChild);
                }
                
                // Clear response interval if any
                if (window.responseInterval) {
                    clearInterval(window.responseInterval);
                    window.responseInterval = null;
                }
            });
            
            // Handle response toggle
            responseToggle.addEventListener('click', function() {
                const isVisible = responseForm.style.display === 'block';
                responseForm.style.display = isVisible ? 'none' : 'block';
                responseToggle.textContent = isVisible ? '+' : 'x';
            });
            
            // Handle form submission
            const gardenForm = document.getElementById('garden-response-form');
            const statusDiv = document.getElementById('response-status');
            
            gardenForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const name = document.getElementById('name').value;
                const message = document.getElementById('message').value;
                const timestamp = new Date().toLocaleString();
                
                // Validate input
                if (!name || !message) {
                    statusDiv.textContent = 'Please fill out all fields.';
                    statusDiv.style.color = '#ff6b6b';
                    return;
                }
                
                // Update status
                statusDiv.textContent = 'Submitting...';
                statusDiv.style.color = 'white';
                
                // URL of your deployed Google Apps Script web app
                const scriptURL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
                
                // Prepare URL with parameters
                const url = new URL(scriptURL);
                url.searchParams.append('name', name);
                url.searchParams.append('message', message);
                url.searchParams.append('timestamp', timestamp);
                
                // Make the fetch request
                fetch(url, {
                    method: 'POST',
                    mode: 'no-cors' // Required for Google Apps Script
                })
                .then(() => {
                    // Success handling
                    statusDiv.textContent = 'Thank you for sharing your thoughts!';
                    statusDiv.style.color = '#4CAF50';
                    gardenForm.reset();
                    
                    // Add to responses
                    if (window.responses) {
                        window.responses.push({ name, message });
                    }
                    
                    // Hide form after successful submission
                    setTimeout(() => {
                        responseForm.style.display = 'none';
                        responseToggle.textContent = '+';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusDiv.textContent = 'Network error. Please try again.';
                    statusDiv.style.color = '#ff6b6b';
                });
            });
            
            // Function to place flowers
            function placeFlowers() {
                const flowerContainer = document.getElementById('flower-container');
                const flowerCount = 15;
                const radius = 1.5;
                
                // Flower types (simple geometry for now)
                const flowerTypes = [
                    { color: '#FF5733', height: 0.3 },  // Orange
                    { color: '#DAF7A6', height: 0.25 }, // Light green
                    { color: '#FFC300', height: 0.2 },  // Yellow
                    { color: '#C70039', height: 0.35 }, // Red
                    { color: '#9B59B6', height: 0.3 },  // Purple
                    { color: '#3498DB', height: 0.25 }  // Blue
                ];
                
                // Place flowers in a circle
                for (let i = 0; i < flowerCount; i++) {
                    // Calculate position in a circle
                    const angle = (i / flowerCount) * Math.PI * 2;
                    const randomRadius = radius * (0.3 + Math.random() * 0.7);
                    const x = Math.cos(angle) * randomRadius;
                    const z = Math.sin(angle) * randomRadius;
                    
                    // Select flower type
                    const flowerType = flowerTypes[Math.floor(Math.random() * flowerTypes.length)];
                    
                    // Create flower stem
                    const stem = document.createElement('a-cylinder');
                    stem.setAttribute('position', `${x} ${-0.2} ${z}`);
                    stem.setAttribute('radius', '0.02');
                    stem.setAttribute('height', '0.4');
                    stem.setAttribute('color', '#2ECC71');
                    stem.setAttribute('animation__grow', {
                        property: 'scale',
                        from: '1 0 1',
                        to: '1 1 1',
                        dur: 2000 + Math.random() * 1000,
                        delay: 500 + Math.random() * 2000,
                        easing: 'easeOutElastic'
                    });
                    flowerContainer.appendChild(stem);
                    
                    // Create flower head
                    const flowerHead = document.createElement('a-entity');
                    flowerHead.setAttribute('position', `${x} ${flowerType.height - 0.2} ${z}`);
                    
                    // Randomize flower appearance
                    const flowerGeom = Math.random() > 0.5 ? 'a-sphere' : 'a-cone';
                    const flower = document.createElement(flowerGeom);
                    flower.setAttribute('radius', '0.08 + Math.random() * 0.05');
                    flower.setAttribute('color', flowerType.color);
                    flower.setAttribute('segments-height', '1');
                    flower.setAttribute('segments-radial', '8');
                    flower.setAttribute('scale', '0 0 0');
                    flower.setAttribute('animation__bloom', {
                        property: 'scale',
                        from: '0 0 0',
                        to: '1 1 1',
                        dur: 1500,
                        delay: 2500 + Math.random() * 2000,
                        easing: 'easeOutElastic'
                    });
                    
                    // Add flower sway animation
                    flowerHead.setAttribute('animation__sway', {
                        property: 'rotation',
                        from: `0 0 ${-5 - Math.random() * 5}`,
                        to: `0 0 ${5 + Math.random() * 5}`,
                        dur: 2000 + Math.random() * 3000,
                        delay: 3000 + Math.random() * 1000,
                        easing: 'easeInOutSine',
                        loop: 'true',
                        dir: 'alternate'
                    });
                    
                    flowerHead.appendChild(flower);
                    flowerContainer.appendChild(flowerHead);
                }
                
                // Load and cycle responses
                loadResponses();
            }
            
            // Load responses
            function loadResponses() {
                // Default responses
                window.responses = [
                    { name: "Jane", message: "We need more green space in our neighborhood!" },
                    { name: "Carlos", message: "It would bring our community together." },
                    { name: "Aisha", message: "I'd love to grow vegetables with my neighbors." }
                ];
                
                // URL of Google Apps Script
                const scriptURL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?action=getResponses';
                
                // Try to load real responses
                fetch(scriptURL)
                    .then(response => response.json())
                    .then(data => {
                        if (data.result === 'success' && data.responses && data.responses.length > 0) {
                            window.responses = data.responses;
                            console.log(`Loaded ${window.responses.length} responses`);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading responses:', error);
                    })
                    .finally(() => {
                        // Start cycling responses
                        showNextResponse();
                        window.responseInterval = setInterval(showNextResponse, 12000);
                    });
            }
            
            // Show next response
            window.currentResponseIndex = -1;
            function showNextResponse() {
                if (!window.responses || window.responses.length === 0) return;
                
                // Get next response
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * window.responses.length);
                } while (window.responses.length > 1 && newIndex === window.currentResponseIndex);
                
                window.currentResponseIndex = newIndex;
                const response = window.responses[window.currentResponseIndex];
                
                // Update display
                const responseDisplay = document.getElementById('response-display');
                responseDisplay.setAttribute('value', `"${response.message}"\n- ${response.name}`);
                
                // Animate opacity
                responseDisplay.setAttribute('opacity', '0');
                responseDisplay.setAttribute('animation__fade', {
                    property: 'opacity',
                    from: '0',
                    to: '1',
                    dur: '1000',
                    easing: 'easeOutQuad'
                });
            }
        });
    </script>
</body>
</html>